package com.announcify.queue;

import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import android.content.Context;
import android.content.res.Resources;

import com.announcify.contact.Contact;
import com.announcify.text.Formatter;
import com.announcify.util.HeadsetFinder;
import com.announcify.util.PluginSettings;

public class PrepareMachine {
	public static final String MODE_CUSTOM = "com.announcify.CUSTOM";
	public static final String MODE_UNKNOWN = "com.announcify.UNKNOWN";

	private final PluginSettings settings;
	private final Context context;
	private final Contact contact;
	private String text;
	private final String message;

	public PrepareMachine(final Context context, final PluginSettings settings, final Contact contact, final String message) {
		this.settings = settings;
		this.context = context;
		this.contact = contact;
		this.message = message;
	}

	public String getName() {
		return text;
	}

	public List<Object> prepare() {
		List<Object> list = new LinkedList<Object>();

		prepareName();

		if ("".equals(text) || text == null) {
			return list;
		}

		for (int i = 0; i < settings.getReadingRepeat(); i++) {
			list.add(text);
			list.add(new Integer(settings.getReadingBreak()));
		}

		return list;
	}

	private void prepareName() {
		final String temp = contact.getUserPreferredName();
		if ("".equals(temp)) {
			String mode = settings.getUnknownMode();

			if ("".equals(mode)) return;

			if (MODE_UNKNOWN.equals(mode)) {
				text = getUnknownString();
				return;
			}

			if (MODE_CUSTOM.equals(mode)) {
				// TODO: get custom
				text = settings.getCustomUnknownAnnouncement();
			} else {
				text = mode;
			}

			applyFormat(getUnknownString());
		} else {
			text = temp;

			prepareAnnouncement();
		}
	}

	private void applyFormat(String name) {
		Map<String, String> expressions = new HashMap<String, String>();
		expressions.put(Formatter.ADDRESS, contact.getAddress());
		expressions.put(Formatter.ADDRESS_TYPE, contact.getAddressType());
		expressions.put(Formatter.NAME, contact.getAddress());
		// Formatter.replaceExpressions(expressions, text);
	}

	private void prepareAnnouncement() {
		if (HeadsetFinder.isDiscreet(context)) {
			text = settings.getDiscreetMode();

			if (text.equals(MODE_CUSTOM)) {
				text = settings.getCustomDiscreetAnnouncement();
			}
		} else {
			text = settings.getAnnouncementMode();

			if (text.equals(MODE_CUSTOM)) {
				text = settings.getCustomAnnouncement();
			}
		}

		applyFormat();
	}

	private String getUnknownString() {
		return Resources.getSystem().getString(android.R.string.unknownName);
		// UNKNOWN = UNKNOWN.substring(1, UNKNOWN.length() - 1);
	}
}