package com.announcify.plugin.call.service;

import java.util.LinkedList;

import android.content.Intent;
import android.telephony.TelephonyManager;

import com.announcify.api.contact.Contact;
import com.announcify.api.contact.Formatter;
import com.announcify.api.contact.lookup.Mail;
import com.announcify.api.contact.lookup.Call;
import com.announcify.api.error.ExceptionHandler;
import com.announcify.api.queue.PluginQueue;
import com.announcify.api.service.PluginService;
import com.announcify.plugin.call.receiver.RingtoneReceiver;
import com.announcify.plugin.call.util.CallnouncifySettings;

public class WorkerService extends PluginService {

	public WorkerService() {
		super("Announcify - Call");
	}

	
	@Override
	protected void onHandleIntent(final Intent intent) {
		Thread.setDefaultUncaughtExceptionHandler(new ExceptionHandler(this, Thread.getDefaultUncaughtExceptionHandler()));
		
		final CallnouncifySettings settings = new CallnouncifySettings(this);

		final String number = intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER);
		final Contact contact = new Contact(this, new Call(this));
		
		if (number != null && !"".equals(number)) {
			new Formatter(this, contact, settings);
		}

		final PrepareMachine prepare = new PrepareMachine(this, settings, contact, "");
		final LinkedList<Object> list = prepare.prepare();

		if (list.isEmpty()) {
			return;
		}

		if (settings.getReadingWait() > 1000) {
			try {
				Thread.sleep(settings.getReadingWait());
			} catch (final InterruptedException e) {}
		}

		final PluginQueue queue = new PluginQueue("Callnouncify", list, RingtoneReceiver.ACTION_START_RINGTONE, "", this);
		queue.sendToService(this, 0);
	}
}
