package com.announcify.plugin.talk.service;

import android.content.Intent;
import android.database.ContentObserver;
import android.database.Cursor;
import android.net.Uri;
import android.os.Handler;
import android.os.IBinder;
import android.util.Log;

public class TalkService extends WorkerService {
	@Override
	public void onCreate() {
		// TODO Auto-generated method stub
		super.onCreate();
	}
	
	private class TalkObserver extends ContentObserver {
		
		public TalkObserver(Handler handler) {
			super(handler);
		}

		@Override
		public void onChange(final boolean selfChange) {
			Cursor message = getContentResolver().query(Uri.withAppendedPath(Uri.parse("content://com.google.android.providers.talk/"), "messages"), null, "err_code = 0", null, "date DESC");
			message.moveToFirst();

			// body

			Log.e("smn", "-----------");

			Cursor conversation = getContentResolver().query(Uri.withAppendedPath(Uri.parse("content://com.google.android.providers.talk/"), "chats"), null, null, null, "last_message_date DESC");
			conversation.moveToFirst();

			// last_unread_message

			Log.e("smn", "-----------");

			Cursor contact = getContentResolver().query(Uri.withAppendedPath(Uri.parse("content://com.google.android.providers.talk/contacts"), "1"), null, "last_message_date = " + conversation.getLong(conversation.getColumnIndex("last_message_date")), null, null);
			contact.moveToFirst();

			// nickname / username

			contact.close();
			conversation.close();
			message.close();

			final Intent intent = new Intent(TalkService.this, WorkerService.class);
			intent.putExtra(WorkerService.EXTRA_FROM, messages.getString(messages.getColumnIndex(projection[0])));
			intent.putExtra(WorkerService.EXTRA_SUBJECT, conversations.getString(conversations.getColumnIndex(projection[1])));
			intent.putExtra(WorkerService.EXTRA_SNIPPET, conversations.getString(conversations.getColumnIndex(projection[2])));
			startService(intent);

			messages.close();
			conversations.close();
		}
	}

	@Override
	public IBinder onBind(Intent arg0) {
		return null;
	}
}