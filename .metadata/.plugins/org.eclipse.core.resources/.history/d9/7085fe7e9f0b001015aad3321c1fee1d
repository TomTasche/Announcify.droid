package com.announcify.plugin.talk.service;

import android.content.Intent;
import android.database.ContentObserver;
import android.database.Cursor;
import android.net.Uri;
import android.os.Handler;
import android.os.IBinder;

public class TalkService extends WorkerService {
	@Override
	public void onCreate() {
		// TODO Auto-generated method stub
		super.onCreate();
	}
	
	private class TalkObserver extends ContentObserver {
		private final String address;

		public TalkObserver(final Handler handler, final String address) {
			super(handler);

			this.address = address;
		}

		@Override
		public void onChange(final boolean selfChange) {
			String[] projection = new String[] {"conversation_id"};
			final Cursor conversations = getContentResolver().query(Uri.parse("content://gmail-ls/conversations/" + Uri.encode(address)), projection, null, null, null);
			conversations.moveToFirst();

			final long conversationId = Long.valueOf(conversations.getString(conversations.getColumnIndex(projection[0])));

			// for (String s : conversations.getColumnNames()) {
			// try {
			// Log.e("smn", ":" + s);
			// Log.e("smn",
			// conversations.getString(conversations.getColumnIndex(s)));
			// } catch (Exception e) {
			// }
			// }
			//
			// Log.e("smn", "------------");

			projection = new String[] {"fromAddress", "subject", "snippet"};

			final Cursor messages = getContentResolver().query(Uri.parse("content://gmail-ls/conversations/" + address + "/" + Uri.parse(String.valueOf(conversationId)) + "/messages"), projection, null, null, null);
			messages.moveToLast();

			// for (String s : messages.getColumnNames()) {
			// try {
			// Log.e("smn", ":" + s);
			// Log.e("smn", messages.getString(messages.getColumnIndex(s)));
			// } catch (Exception e) {
			// }
			// }

			if (!settings.getReadOwn() && address.equals(messages.getString(messages.getColumnIndex(projection[0])))) {
				return;
			}

			final Intent intent = new Intent(TalkService.this, WorkerService.class);
			intent.putExtra(WorkerService.EXTRA_FROM, messages.getString(messages.getColumnIndex(projection[0])));
			intent.putExtra(WorkerService.EXTRA_SUBJECT, conversations.getString(conversations.getColumnIndex(projection[1])));
			intent.putExtra(WorkerService.EXTRA_SNIPPET, conversations.getString(conversations.getColumnIndex(projection[2])));
			startService(intent);

			messages.close();
			conversations.close();
		}
	}

	@Override
	public IBinder onBind(Intent arg0) {
		return null;
	}
}