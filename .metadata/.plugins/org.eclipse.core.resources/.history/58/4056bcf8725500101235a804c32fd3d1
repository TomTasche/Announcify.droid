package com.announcify.plugin.mail.google.activity;

import android.content.Intent;
import android.database.Cursor;
import android.media.RingtoneManager;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;

import com.announcify.api.ui.activity.PluginActivity;
import com.announcify.plugin.mail.google.R;
import com.announcify.plugin.mail.google.service.MailService;
import com.announcify.plugin.mail.google.util.Settings;

public class SettingsActivity extends PluginActivity {

    @Override
    protected void onActivityResult(final int requestCode, final int resultCode, final Intent data) {
        parseRingtone(requestCode, resultCode, data, RingtoneManager.TYPE_NOTIFICATION);

        super.onActivityResult(requestCode, resultCode, data);
    }

    @Override
    public void onCreate(final Bundle savedInstanceState) {
        super.onCreate(savedInstanceState, new Settings(this), R.xml.preferences_settings);

        addPreferencesFromResource(R.xml.preferences_mail_settings);


        Cursor unread = null;
        Cursor conversations = null;
        Cursor messages = null;
        
        String[] projection = new String[] { "name", "numUnreadConversations" };
        unread = getContentResolver().query(Uri.parse("content://gmail-ls/labels/" + "tomtasche@gmail.com"), projection, projection[0] + " = ?", new String[] {"^u"}, null);
        if (!unread.moveToFirst()) {
            return;
        }
        
        if (unread.getInt(unread.getColumnIndex(projection[1])) <= 0) return;
        
        projection = new String[] { "conversation_id", "maxMessageId" };
        conversations = getContentResolver().query(Uri.parse("content://gmail-ls/conversations/" + address), projection, null, null, null);
        if (!conversations.moveToFirst()) {
            return;
        }

        final long conversationId = Long.valueOf(conversations.getString(conversations.getColumnIndex(projection[0])));

        projection = new String[] { "fromAddress", "subject", "snippet", "body" };
        messages = getContentResolver().query(Uri.parse("content://gmail-ls/conversations/" + "tomtasche@gmail.com" + "/" + Uri.parse(String.valueOf(conversationId)) + "/messages"), projection, null, null, null);
        if (!messages.moveToLast()) {
            return;
        }
        
        Log.e("smn", messages.getString(messages.getColumnIndex(projection[1]));
    }

    @Override
    protected void onPause() {
        final Intent serviceIntent = new Intent(this, MailService.class);
        stopService(serviceIntent);
        startService(serviceIntent);

        super.onPause();
    }
}
